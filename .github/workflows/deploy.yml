name: Deploy Portfolio to Production

on:
  push:
    branches: [ master ]
  workflow_dispatch: # Allow manual triggering

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Build application
      run: npm run build

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          set -e
          echo "ğŸš€ Starting portfolio deployment..."
          
          # Navigate to project directory
          echo "Navigating to project directory..."
          cd /home/boff/projects/personal/tvvignesh.github.io
          
          # Backup current dist folder
          if [ -d "dist" ]; then
            echo "ğŸ“¦ Backing up current dist folder..."
            mv dist dist_backup_$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Pull latest changes
          echo "â¬‡ï¸ Pulling latest changes from master..."
          git fetch origin master
          git reset --hard origin/master
          
          # Setup Node.js environment
          source ~/.nvm/nvm.sh && nvm use node
          
          # Install dependencies and build
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
          # Verify deployment
          if [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š Deployment stats:"
            ls -la dist/
          else
            echo "âŒ Deployment verification failed - dist folder or index.html missing"
            exit 1
          fi
          
          # Clean up old backups (keep only last 3)
          ls -dt dist_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf 2>/dev/null || true
          echo "ğŸ§¹ Cleaned up old backups"
          
          # Reload nginx if needed
          sudo systemctl reload nginx || echo "âš ï¸ Nginx reload failed or not needed"
